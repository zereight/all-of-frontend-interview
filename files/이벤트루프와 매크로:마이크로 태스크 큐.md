# 이벤트 루프와 매크로 태스크, 마이크로 태스크

https://ko.javascript.info/event-loop

브라우저 측 자바스크립트 실행 흐름은 Node.js와 마찬가지로 이벤트 루프에 기반한다.



## 이벤트 루프

이벤트 루프 정의는 간단하다.

이벤트 루프는 태스크가 들어오기를 기다려싿가 태스크가 들어오면, 
그것을 처리하고, 
처리할 태스크가 없으면 잠드는,
끊임없이 돌아가는 자바스크립트 내 루프이다.

즉,

1. 처리해야할 태스크가 있는 경우

   먼저 들어온 태스크부터 순차적으로 처리함

2. 처리해야할 태스크가 없는 경우

   잠들어 있다가 새로운 태스크가 추가되면 다시 1로 돌아감



이렇게 자바스크립트 엔진은 대부분의 시간 동안 아무런 일도 하지 않다가, 스크립트나 이벤트가 활성될 때만 돌아간다.



이때 엔진은 다음과 같은 특성을 보인다.

1. 엔진이 특정 태스크를 처리하는 동안에는 렌더링이 절대 일어나지 않는다. 태스크를 처리하는데 시간이 길지 않으면 문제가 되지 않는다. 처리가 끝나면 DOM에 반영하면 되기 때문에
2. 만약, 태스크 처리에 긴 시간이 걸리면, 그 중간에서 발생하는 사용자 이벤트 등의 새로운 태스크들을 처리하지 못한다.



## 매크로태스크와 마이크로태스크



마이크로 태스크는 코드를 사용해서만 만들 수 있는데, 주로 Promise를 사용해서 만든다.

Promise와 함께 쓰이는 then/catch/finally 또는 await 핸들러가 마이크로 태스크가 되는 것이다.

그 외에도 `queueMicrotask(func)` 을 사용하면 마이크로 태스크 큐에 직접 넣을 수 있다.



이때, 자바스크립트 엔진은 매크로 태스크 하나를 처리하고 난 직후, 다른 매크로 태스크나 렌더링 작업을 하기 전에 마이크로 태스크 큐에 있는 마이크로 태스크의 전부를 처리한다.

예를 들어서 아래와 같은 코드가 있으면

```js
setTimeout(() => alert('timeout'));

Promise.resolve().then(() => alert('promise'));

alert('code');
```



1. code 는 일반적인 동기 호출로 실행
2. promise는 .then이 마이크로 태스크 큐에 들어가서 처리
3. timeout은 매크로 태스크 큐에 들어가서 처리





## Recap

위 개념을 정리하여 요약하자면 다음과 같다.

1. 매크로 태스크 큐에서 가장 오래된 태스크를 꺼내서 실행한다. 
2. 모든 마이크로 태스크를 실행한다.
   이 작업은 마이크로 태스크 큐가 빌 때까지 이어지고 태스크는 오래된 순서대로 처리된다.
3. 렌더링할 것이 있으면 처리한다.
4. 매크로 태스크 큐가 비어있으면 새로운 매크로 태스크가 나타날 때까지 기다린다.
5. 1번으로 간다.





